////第3步,通过已知道的type_id.json来下载html，获取--详情页----地图

var casper = require('casper').create();



var origin="dianping.com/shop/";

var _ID=["1902862","43616597","66860473","19670205","24633052","18053835","27311183","17869659","3056302","522398","5224264","17846611","512075","13703446","1796314","13764057","32883444","22350718","19592696","6096920","32638191","3891889","19416247","20731524","27198912","32462758","19450319","5374910","22827687","2693254","24608007","4131721","5306307","17957718","21117786","15909534","21670471","8995198","2383222","23572426","6043927","14892760","21171513","4272562","2382304","500407","19011222","2939686","3132361","22162457","500714","18499724","5275754","23895008","3876475","2786317","9964281","6015312","20953235","3292306","8353544","11566615","18397825","17940227","9040316","18326475","5183684","33599276","2878744","2420104","5149335","2650585","2640982","5391580","66104376","15928431","1891444","500346","3311626","5371439","2103985","21362798","6116539","6136444","2491156","4674001","12592198","58490499","2795311","37942165","21083941","5411868","3441013","2220496","13665974","4538396","13879004","21090022","6007901","2285251","4092412","4500491","1966345","3500710","2060188","5588943","6225640","15117629","5743843","18325667","45829444","58400820","18220202","23481472","10343688","24337026","22675929","24011289","22736557","19170415","21869582","17889474","20685891","19145913","21172060","5239407","2459488","52348336","23584188","8020875","23912021","18685223","13803854","9359347","6357438","67112164","18498945","27314032","26979034","517014","8920228","17180012","27148257","23214020","22163464","13799609","24899623","23594892","13665834","21007122","66381841","65594166","23595507","27511239","5325201","14903180","2027095","4135811","8977492","8004243","4133350","2034064","2943646","24096337","18377708","4621391","18814971","21413229","2211082","63057639","23740568","17679013","18080179","18357630","4269890","22517173","4285905","9322234","2692024","8693057","21049219","9462534","3370339","4713472","43557139","67439680","500617","17931142","23035634","9976057"];

//index 1_1
var _TYPE="keepfit_shop_1902862";
var links=[];

var count=_ID.length; //爬地图&主页

//var count=198;//爬评论

var downNum=0;

var down_ID=[];
//爬地图&主页
for (var i = _ID.length-1; i >= 0; i--) {
	links.push("http://m."+origin+_ID[i]+"/map");//下地图;
    //links.push("http://m."+origin+_ID[i]);//主页
    //links.push("http://www."+origin+_ID[i]+'/review_more?pageno=1');//爬评论,第1页
	count--;
	if (count<=0) {
		
		console.log("url准备好"+links.length+"个");
		next();
	};
};

//爬评论
/*
for (var i = 198; i >= 1; i--) {
    links.push(origin+i);

    count--;
    if (count<=0) {
        
        console.log("url准备好"+links.length+"个");
        next();
    };
};
*/
function next(){
	casper.start().each(links, function(self, link) {
    	self.thenOpen(link, function() {

    			var page=this.getCurrentUrl().replace(origin,'').replace("/map",'').replace('m.','').replace('http://','')+'m.html';//地图
                
                //var page=this.getCurrentUrl().replace(origin,'').replace('m.','').replace('http://','')+'.html';//主页
                
                //var page=this.getCurrentUrl().replace(origin,'').replace("http://www.","").replace("/review_more?pageno",'')+'p.html';//评论

    			downNum++;
    			down_ID.push(page.replace(".html",""));

    			console.log(page+"-----------第"+downNum);
				this.download(link, "./"+_TYPE+"_page/"+page); 
       
   	 	});
	});

	casper.run(function() {
		var vsResult=chaji_array(down_ID,_ID);
	    this.echo('download Done.but'+vsResult).exit();

	});
};

function chaji_array(arr1,arr2){
    var arr3 = [];
    for (var i = 0; i < arr1.length; i++) {
                        var flag = true;
                        for (var j = 0; j < arr2.length; j++) {
                            if (arr2[j] == arr1[i]) {
                                flag = false;
                            }
                        }
                        if (flag) {
                            arr3.push(arr1[i]);
                        }
                    }
return arr3;
}